html
<!-- START OF FILE text/plain -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Skybound Tycoon: Deep Dark Update</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        body { margin: 0; overflow: hidden; font-family: 'Nunito', sans-serif; background: #87CEEB; user-select: none; }
        
        /* UI LAYERS */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* HUD */
        .hud-panel { 
            position: absolute; 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(4px);
            padding: 12px 20px; 
            border-radius: 15px; 
            color: #2d3436; 
            border-bottom: 5px solid #dfe6e9;
            display: flex; gap: 15px; align-items: center;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            pointer-events: auto;
        }
        
        #stats-hud { bottom: 20px; left: 20px; font-size: 18px; font-weight: 800; display: flex; flex-direction: column; gap: 5px; align-items: flex-start;}
        #tool-hud { bottom: 20px; right: 20px; font-size: 22px; font-weight: 800; color: #6C5CE7; }
        
        /* Mini Quest HUD (Top Right) */
        #quest-hud { top: 20px; right: 20px; flex-direction: column; align-items: flex-end; border-bottom: 5px solid #ffeaa7; background: rgba(255,255,230,0.95); cursor: pointer; transition: transform 0.2s; }
        #quest-hud:hover { transform: scale(1.05); }

        /* Menu Button */
        #menu-btn-container { position: absolute; top: 20px; left: 20px; pointer-events: auto; }
        .btn-menu { background: #636e72; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 24px; cursor: pointer; border-bottom: 4px solid #2d3436; transition: 0.1s; }
        .btn-menu:active { transform: translateY(2px); border-bottom: 2px solid #2d3436; }
        .btn-menu small { font-size: 12px; display: block; opacity: 0.8; }

        /* HEALTH BAR */
        #health-container { width: 150px; height: 20px; background: #555; border-radius: 10px; overflow: hidden; border: 2px solid white; margin-top: 5px; }
        #health-fill { width: 100%; height: 100%; background: #ff7675; transition: width 0.2s; }

        /* FISHING UI */
        #fishing-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); justify-content: center; align-items: center;
            pointer-events: auto; z-index: 2000;
        }
        #minigame-container {
            width: 120px; height: 350px; background-color: #2a2a2a;
            border: 6px solid #8b4513; border-radius: 10px; display: flex;
            flex-direction: row; padding: 5px; box-shadow: 0 0 30px rgba(0,0,0,0.6);
            cursor: none; position: relative;
        }
        #water-column {
            width: 80px; height: 100%; background-color: #005f87;
            background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 100% 20px; position: relative; border: 2px solid #1a1a1a; overflow: hidden;
        }
        #catch-bar {
            width: 100%; height: 100px; background-color: rgba(124, 252, 0, 0.5);
            border-top: 2px solid lime; border-bottom: 2px solid lime;
            position: absolute; bottom: 0; left: 0; transition: bottom 0.05s linear;
        }
        #fish-target {
            width: 34px; height: 34px; background-color: orange; border-radius: 50%;
            position: absolute; left: 50%; bottom: 10px; transform: translateX(-50%);
            border: 2px solid #cc8400; transition: bottom 0.1s linear;
        }
        #progress-container {
            width: 20px; height: 100%; background-color: #444; margin-left: 8px;
            position: relative; border: 2px solid black; border-radius: 4px; overflow: hidden;
        }
        #progress-fill {
            width: 100%; height: 30%; background: linear-gradient(to top, yellow, green);
            position: absolute; bottom: 0; transition: height 0.1s linear;
        }
        #fishing-instr {
            position: absolute; top: -50px; width: 300px; left: 50%; transform: translateX(-50%);
            color: white; font-family: 'Fredoka One'; text-align: center; text-shadow: 2px 2px 0 #000; font-size: 20px;
        }
        #reaction-cue {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: yellow; font-family: 'Fredoka One'; font-size: 80px;
            text-shadow: 4px 4px 0 #000; pointer-events: none; display: none;
            animation: shake 0.2s infinite; z-index: 1500;
        }
        @keyframes shake { 0% { transform: translate(-50%, -50%) rotate(0deg); } 25% { transform: translate(-50%, -50%) rotate(10deg); } 75% { transform: translate(-50%, -50%) rotate(-10deg); } }

        /* NOTIFICATIONS */
        #notification-area {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 8px; align-items: center; pointer-events: none; z-index: 3000;
        }
        .toast {
            background: #FFD700; color: #553300; padding: 8px 24px; 
            border-radius: 50px; font-family: 'Fredoka One'; font-size: 20px;
            animation: popIn 0.3s forwards, fadeOut 0.5s 3s forwards;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
        }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

        /* FLOATING TEXT */
        .float-text {
            position: absolute; font-family: 'Fredoka One'; font-weight: bold; font-size: 24px;
            text-shadow: 2px 2px 0 #000; pointer-events: none;
            animation: floatUp 1s forwards;
        }
        @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }

        /* CROSSHAIR */
        #crosshair { 
            position: absolute; top: 50%; left: 50%; 
            width: 10px; height: 10px; 
            background: white; border: 2px solid #2d3436; 
            border-radius: 50%; transform: translate(-50%, -50%); 
        }

        /* INTERACT MSG */
        #interact-msg { 
            position: absolute; top: 60%; left: 50%; 
            transform: translate(-50%, -50%); 
            font-family: 'Fredoka One', cursive; font-size: 24px; color: white;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 8px;
            display: none; border: 2px solid white;
        }

        /* UNIVERSAL MODAL (Shop & Settings) */
        .modal-menu { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 850px; height: 600px;
            background: #f5f6fa; border: 8px solid #6C5CE7; 
            border-radius: 20px; 
            pointer-events: auto; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            flex-direction: column; overflow: hidden;
            z-index: 1000;
        }
        .modal-header {
            background: #6C5CE7; color: white; padding: 15px; text-align: center;
            font-family: 'Fredoka One', cursive; font-size: 32px; letter-spacing: 2px;
            position: relative;
        }
        .modal-tabs { display: flex; background: #a29bfe; overflow-x: auto;}
        .tab-btn { 
            flex: 1; border: none; background: transparent; padding: 15px; 
            font-family: 'Fredoka One', cursive; color: rgba(255,255,255,0.6); 
            font-size: 16px; cursor: pointer; transition: 0.2s; min-width: 100px;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .tab-btn.active { background: #f5f6fa; color: #6C5CE7; }
        .modal-content { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; font-weight: bold;}

        /* SHOP SPECIFIC */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .item-card { 
            background: white; border-radius: 12px; padding: 15px; 
            border: 2px solid #dcdde1; display: flex; flex-direction: column; 
            transition: transform 0.2s;
        }
        .item-card:hover { transform: translateY(-3px); border-color: #6C5CE7; }
        .buy-btn { 
            background: #00b894; color: white; border: none; padding: 10px; 
            border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: auto;
            transition: 0.1s; border-bottom: 4px solid #008469;
        }
        .buy-btn:active { transform: translateY(2px); border-bottom: 2px solid #008469; }
        .buy-btn:disabled { background: #b2bec3; border-color: #636e72; cursor: not-allowed; }

        /* SETTINGS, ACHIEVEMENTS & QUESTS */
        .setting-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; border: 2px solid #dcdde1; }
        .setting-label { font-weight: bold; font-size: 18px; }
        input[type="range"] { width: 200px; }
        .keybind-btn { background: #dfe6e9; border: 2px solid #b2bec3; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; min-width: 80px;}
        .keybind-btn.recording { background: #ff7675; color: white; border-color: #d63031; }

        .quest-card { background: white; padding: 15px; border-radius: 10px; border-left: 8px solid #b2bec3; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .quest-card.complete { border-left-color: #00b894; opacity: 0.7; }
        .quest-prog { background: #dfe6e9; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .quest-fill { height: 100%; background: #0984e3; width: 0%; transition: width 0.5s; }

        .ach-card { background: #fff; border: 2px solid #fdcb6e; border-radius: 10px; padding: 15px; display:flex; justify-content: space-between; align-items: center;}
        .ach-card.locked { filter: grayscale(1); opacity: 0.8; background: #eee; border-color: #ccc; }
        .ach-icon { font-size: 30px; margin-right: 15px; }
        .ach-info { flex: 1; }
        .ach-reward { background: #ffeaa7; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; color: #d35400; }

        /* START SCREEN */
        #blocker { position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #74b9ff, #a29bfe); display: flex; justify-content: center; align-items: center; z-index: 999; }
        #instructions { text-align: center; color: white; }
        h1 { font-family: 'Fredoka One', cursive; font-size: 80px; margin: 0; color: #ffeaa7; text-shadow: 5px 5px 0 #e17055; }
        .btn-start { background: #fd79a8; color: white; font-family: 'Fredoka One'; font-size: 28px; padding: 15px 60px; border: none; border-radius: 50px; border-bottom: 8px solid #e84393; margin-top: 30px; cursor: pointer; transition: 0.2s; }
        .btn-start:hover { transform: scale(1.05); }
        .save-controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .btn-small { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; border-bottom: 4px solid #4834d4; }
        .btn-small:hover { transform: translateY(-2px); }

    </style>
</head>
<body>

    <div id="blocker">
        <div id="instructions">
            <h1>SKYBOUND TYCOON</h1>
            <h2 style="font-weight: normal; opacity: 0.9;">Deep Dark Update</h2>
            <p style="font-size: 20px;">Farm ‚Ä¢ Fish ‚Ä¢ Ranch ‚Ä¢ Mine ‚Ä¢ Forge ‚Ä¢ Automate</p>
            <button class="btn-start" id="start-btn">PLAY</button>
            <div class="save-controls">
                <button class="btn-small" onclick="game.saveGame()">SAVE GAME</button>
                <button class="btn-small" onclick="game.loadGame()">LOAD GAME</button>
            </div>
            <p style="margin-top:20px; opacity:0.8; font-size: 14px;">[1-6] TOOLS | [E] INTERACT | [TAB] MENU</p>
        </div>
    </div>

    <div id="ui-layer">
        <div id="crosshair"></div>
        <div id="interact-msg">PRESS E</div>
        
        <div id="menu-btn-container">
            <button class="btn-menu" onclick="game.toggleSettings()">
                ‚öôÔ∏è MENU
                <small>[TAB]</small>
            </button>
        </div>

        <!-- FISHING MINIGAME OVERLAY -->
        <div id="fishing-overlay">
            <div id="minigame-container">
                <div id="fishing-instr">MOVE MOUSE UP/DOWN</div>
                <div id="water-column">
                    <div id="catch-bar"></div>
                    <div id="fish-target"></div>
                </div>
                <div id="progress-container">
                    <div id="progress-fill"></div>
                </div>
            </div>
        </div>

        <div id="reaction-cue">!</div>
        <div id="notification-area"></div>
        
        <div id="quest-hud" class="hud-panel" onclick="game.openQuests()">
            <div style="font-size:14px; color:#b2bec3;">ACTIVE QUEST (Click for All)</div>
            <div id="quest-text" style="color:#d63031;">Loading...</div>
        </div>

        <div id="stats-hud" class="hud-panel">
            <div>üí∞ <span id="ui-coins">0</span></div>
            <div>üéí <span id="ui-bag">0</span>/<span id="ui-max">10</span></div>
            <div id="health-container"><div id="health-fill"></div></div>
        </div>

        <div id="tool-hud" class="hud-panel">
            <span id="tool-icon">üß§</span> <span id="tool-name">HANDS</span>
        </div>
    </div>

    <!-- Shop Menu -->
    <div id="shop-menu" class="modal-menu">
        <div class="shop-header">ISLAND MARKETPLACE</div>
        <button class="close-btn" onclick="game.closeShop()">√ó</button>
        <div class="modal-tabs">
            <button class="tab-btn active" onclick="game.setTab('upgrades')">‚ö° Upgrades</button>
            <button class="tab-btn" onclick="game.setTab('farming')">ü•ï Farming</button>
            <button class="tab-btn" onclick="game.setTab('ranch')">üêÆ Ranch</button>
            <button class="tab-btn" onclick="game.setTab('fishing')">üé£ Fishing</button>
            <button class="tab-btn" onclick="game.setTab('forge')">‚öíÔ∏è Forge</button>
            <button class="tab-btn" onclick="game.setTab('automation')">ü§ñ Auto</button>
            <button class="tab-btn" onclick="game.setTab('permits')">üìú Permits</button>
        </div>
        <div id="shop-content" class="modal-content shop-grid"></div>
        <div style="padding: 20px; background: #dfe6e9; text-align: center;">
            <button class="buy-btn" style="background: #e17055; width: 100%; border-color: #d35400; font-size: 18px;" onclick="game.sellAll()">SELL INVENTORY (<span id="sell-val">0</span> üí∞)</button>
        </div>
    </div>

    <!-- Settings & Quest Menu -->
    <div id="settings-menu" class="modal-menu">
        <div class="modal-header">PAUSE MENU</div>
        <button class="close-btn" onclick="game.closeSettings()">√ó</button>
        <div class="modal-tabs">
            <button class="tab-btn active" onclick="game.setSettingsTab('quests')">üìú Quests</button>
            <button class="tab-btn" onclick="game.setSettingsTab('achievements')">üèÜ Achievements</button>
            <button class="tab-btn" onclick="game.setSettingsTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab-btn" onclick="game.setSettingsTab('controls')">üéÆ Controls</button>
        </div>
        <div id="settings-content" class="modal-content"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- AUDIO SYSTEM ---
        const AudioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            vol: { sfx: 0.5, music: 0.5 },
            playTone: (freq, type, duration, vol=0.1) => {
                if(AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
                if(AudioSys.vol.sfx <= 0) return;
                const osc = AudioSys.ctx.createOscillator();
                const gain = AudioSys.ctx.createGain();
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol * AudioSys.vol.sfx, AudioSys.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, AudioSys.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(AudioSys.ctx.destination);
                osc.start(); osc.stop(AudioSys.ctx.currentTime + duration);
            },
            buy: () => AudioSys.playTone(600, 'square', 0.2),
            coin: () => AudioSys.playTone(1200, 'sine', 0.1),
            pop: () => AudioSys.playTone(800, 'triangle', 0.05),
            hit: () => AudioSys.playTone(150, 'sawtooth', 0.1, 0.2),
            clank: () => AudioSys.playTone(400, 'square', 0.05, 0.3),
            wood: () => AudioSys.playTone(200, 'sawtooth', 0.1, 0.3),
            build: () => AudioSys.playTone(200, 'square', 0.1, 0.3),
            splash: () => {
                if(AudioSys.vol.sfx <= 0) return;
                const buf = AudioSys.ctx.createBuffer(1, AudioSys.ctx.sampleRate*0.5, AudioSys.ctx.sampleRate);
                const data = buf.getChannelData(0);
                for(let i=0; i<data.length; i++) data[i] = Math.random()*2-1;
                const src = AudioSys.ctx.createBufferSource(); src.buffer=buf;
                const g = AudioSys.ctx.createGain(); g.gain.value=0.2 * AudioSys.vol.sfx;
                g.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime+0.5);
                src.connect(g); g.connect(AudioSys.ctx.destination); src.start();
            },
            win: () => {
                 AudioSys.playTone(523, 'sine', 0.1, 0.2);
                 setTimeout(()=>AudioSys.playTone(659, 'sine', 0.1, 0.2), 100);
                 setTimeout(()=>AudioSys.playTone(783, 'sine', 0.2, 0.2), 200);
            }
        };

        // --- MUSIC SYSTEM ---
        const MusicSys = {
            active: false,
            timer: 0,
            trackIdx: 0,
            noteIdx: 0,
            tracks: [
                { speed: 0.6, notes: [ [330,1], [392,1], [493,1], [392,1], [330,2], [293,2], [261,4], [0,2] ] },
                { speed: 0.2, notes: [ [440,1], [0,1], [440,1], [523,1], [587,2], [523,1], [440,2], [392,2] ] },
                { speed: 0.8, notes: [ [110,4], [130,4], [98,4], [110,4], [0,4] ] }
            ],
            update: (delta) => {
                if(AudioSys.vol.music <= 0) return;
                MusicSys.timer -= delta;
                if(MusicSys.timer <= 0) {
                    const track = MusicSys.tracks[MusicSys.trackIdx];
                    const note = track.notes[MusicSys.noteIdx];
                    if(note[0] > 0) {
                        const osc = AudioSys.ctx.createOscillator();
                        const gain = AudioSys.ctx.createGain();
                        osc.type = 'sine'; osc.frequency.value = note[0];
                        gain.gain.setValueAtTime(0.05 * AudioSys.vol.music, AudioSys.ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0, AudioSys.ctx.currentTime + (note[1]*track.speed));
                        osc.connect(gain); gain.connect(AudioSys.ctx.destination);
                        osc.start(); osc.stop(AudioSys.ctx.currentTime + (note[1]*track.speed));
                    }
                    MusicSys.timer = note[1] * track.speed;
                    MusicSys.noteIdx++;
                    if(MusicSys.noteIdx >= track.notes.length) {
                        MusicSys.noteIdx = 0;
                        if(Math.random() > 0.7) MusicSys.trackIdx = (MusicSys.trackIdx + 1) % MusicSys.tracks.length;
                    }
                }
            }
        };

        const colors = {
            grass: 0x55efc4, dirt: 0xA0522D, water: 0x74b9ff, sand: 0xffefc0,
            magma: 0x2d3436, lava: 0xff7675, ranch: 0x00b894, stone: 0x636e72, 
            sky: 0xa29bfe, forest: 0x2ecc71, deep: 0x2f3640, titanium: 0xc7ecee
        };

        let state = {
            coins: 50,
            inventory: [], 
            maxInventory: 10,
            isShopOpen: false,
            isSettingsOpen: false,
            currentSettingsTab: 'quests',
            equipped: 'hands',
            hp: 100, maxHp: 100,
            speed: 14, jumpForce: 16, gravity: 35,
            sensitivity: 1.0,
            keybinds: { f: 'KeyW', b: 'KeyS', l: 'KeyA', r: 'KeyD', jump: 'Space', interact: 'KeyE' },
            bindRecording: null,
            stats: { harvests: 0, kills: 0, fish: 0, mined: 0, wood: 0 },
            lvl: { bag: 1 },
            tools: { rod: 0, pick: 0, sword: 0, axe: 0 },
            upgrades: { flight: false, speed: 0, ranchSpeed: false },
            unlocked: { home: true, ranch: false, magma: false, dock: false, mine: false, sky: false, forest: false, deep: false, bossDefeated: false },
            seeds: { carrot: 2, star: 0, moon: 0, lava: 0, solar: 0, void: 0 },
            achievements: [], // List of claimed achievement IDs
            
            plots: [],
            pens: [],
            animals: [],
            mobs: [],
            ores: [],
            trees: [],
            collectors: [],
            builtBlocks: [],
            
            boss: { active: false, hp: 0, maxHp: 500, mesh: null, cooldown: 0 },
            boss2: { active: false, hp: 0, maxHp: 1200, mesh: null, cooldown: 0 },
            
            fishing: { 
                active: false, 
                state: 'IDLE', 
                bobber: null, 
                timer: 0,
                fishPos: 10, fishTarget: 50, barPos: 0, progress: 30, fishTimer: 0 
            }
        };

        // --- CENTRAL SHOP DATA (Solves bugs) ---
        const SHOP_DATA = {
            // Upgrades
            bag_up: { cat:'upgrade', id:'bag', name:'Backpack Mk.II', desc:'+5 Inventory Slots', cost: 0, dynamicCost: true },
            sprinkler: { cat:'upgrade', id:'sprinkler', name:'Sprinkler System', desc:'Auto-water crops', cost: 300 },
            feeder: { cat:'upgrade', id:'feeder', name:'Auto-Feeder', desc:'2x Animal Speed', cost: 800 },
            boots: { cat:'upgrade', id:'boots', name:'Speed Boots', desc:'Run Faster', cost: 500 },
            flight: { cat:'upgrade', id:'flight', name:'Flight Feather', desc:'Access Sky Ruins', cost: 2000 },
            potion: { cat:'potion', id:'hp', name:'Health Potion', desc:'Restore 50 HP', cost: 50 },

            // Seeds
            seed_carrot: { cat:'seed', id:'carrot', name:'Carrot Seed', desc:'Fast. Val: 30', cost: 10 },
            seed_star: { cat:'seed', id:'star', name:'Star Seed', desc:'Med. Val: 100', cost: 40 },
            seed_moon: { cat:'seed', id:'moon', name:'Moon Seed', desc:'Slow. Val: 300', cost: 100 },
            seed_lava: { cat:'seed', id:'lava', name:'Lava Melon Seed', desc:'Magma Only', cost: 250 },
            // Unlockable seeds (purchasable if unlocked via achievement)
            seed_solar: { cat:'seed', id:'solar', name:'Solar Seed', desc:'Glows. Val: 500', cost: 400 },
            seed_void: { cat:'seed', id:'void', name:'Void Seed', desc:'Dark Energy. Val: 800', cost: 600 },

            // Tools (Forge)
            axe_1: { cat:'axe', id:1, name:'Stone Axe', desc:'Chop Trees', cost: 100, mats:[] },
            pick_1: { cat:'pick', id:1, name:'Stone Pickaxe', desc:'Mine Iron', cost: 250, mats:[] },
            pick_2: { cat:'pick', id:2, name:'Iron Pickaxe', desc:'Mine Gold', cost: 750, mats:[{name:'Iron',qty:5},{name:'Wood',qty:10}] },
            pick_3: { cat:'pick', id:3, name:'Diamond Pickaxe', desc:'Mine All', cost: 2500, mats:[{name:'Diamond',qty:3},{name:'Gold',qty:5}] },
            pick_4: { cat:'pick', id:4, name:'Void Pickaxe', desc:'Mines Titanium', cost: 5000, mats:[{name:'Diamond',qty:5},{name:'Sky Crystal',qty:2}] },
            sword_2: { cat:'sword', id:2, name:'Iron Sword', desc:'Dmg: 12', cost: 800, mats:[{name:'Iron',qty:8},{name:'Wood',qty:5}] },
            sword_3: { cat:'sword', id:3, name:'Crystal Blade', desc:'Dmg: 30', cost: 3000, mats:[{name:'Sky Crystal',qty:1},{name:'Diamond',qty:5}] },

            // Rods
            rod_1: { cat:'rod', id:1, name:'Oak Rod', desc:'Basic Rod', cost: 100 },
            rod_2: { cat:'rod', id:2, name:'Fiber Rod', desc:'Better Catch', cost: 500 },
            rod_3: { cat:'rod', id:3, name:'Golden Rod', desc:'Legendary', cost: 2000 },

            // Automation
            auto_farm: { cat:'collector', id:'farm', name:'Farm Auto-Bot', desc:'Harvests (Home)', cost: 1500, mats:[{name:'Iron',qty:10}] },
            auto_ranch: { cat:'collector', id:'ranch', name:'Ranch Auto-Bot', desc:'Collects Drops', cost: 1500, mats:[{name:'Iron',qty:10}] },
            auto_magma: { cat:'collector', id:'magma', name:'Magma Auto-Bot', desc:'Harvests Lava', cost: 2000, mats:[{name:'Gold',qty:5}] },

            // Permits
            perm_ranch: { cat:'permit', id:'ranch', name:'Ranch Permit', desc:'West Island', cost: 400 },
            perm_forest: { cat:'permit', id:'forest', name:'Forest Permit', desc:'Far West Island', cost: 500 },
            perm_magma: { cat:'permit', id:'magma', name:'Magma Permit', desc:'East Island', cost: 800 },
            perm_dock: { cat:'permit', id:'dock', name:'Dock Permit', desc:'South Island', cost: 300 },
            perm_mine: { cat:'permit', id:'mine', name:'Mining Permit', desc:'North Caverns', cost: 1000 },
            perm_deep: { cat:'permit', id:'deep', name:'Deep Dark Permit', desc:'Extreme Danger', cost: 3000 },
            plot_deed: { cat:'plot', id:'na', name:'Land Deed', desc:'+2 Crop Plots', cost: 150 }
        };

        const questList = [
            // General
            { id: 'coin1', type: 'general', text: "Start Up: Earn 50 Coins", target: 50, check: () => state.coins },
            { id: 'coin2', type: 'general', text: "Business: Earn 1000 Coins", target: 1000, check: () => state.coins },
            { id: 'coin3', type: 'general', text: "Tycoon: Earn 10000 Coins", target: 10000, check: () => state.coins },
            { id: 'bag1', type: 'general', text: "Preparation: Buy a Bag Upgrade", target: 2, check: () => state.lvl.bag },
            
            // Farming
            { id: 'farm1', type: 'farming', text: "Novice Farmer: Harvest 3 Crops", target: 3, check: () => state.stats.harvests },
            { id: 'farm2', type: 'farming', text: "Adept Farmer: Harvest 20 Crops", target: 20, check: () => state.stats.harvests },
            { id: 'farm3', type: 'farming', text: "Master Farmer: Harvest 100 Crops", target: 100, check: () => state.stats.harvests },
            
            // Fishing
            { id: 'fish1', type: 'fishing', text: "Gone Fishing: Catch 3 Fish", target: 3, check: () => state.stats.fish },
            { id: 'fish2', type: 'fishing', text: "Angler: Catch 15 Fish", target: 15, check: () => state.stats.fish },
            { id: 'fish3', type: 'fishing', text: "Deep Sea: Catch 50 Fish", target: 50, check: () => state.stats.fish },
            { id: 'rod1', type: 'fishing', text: "Upgrade: Buy Fiber Rod", target: 2, check: () => state.tools.rod },
            
            // Mining
            { id: 'mine1', type: 'mining', text: "Miner: Mine 5 Ores", target: 5, check: () => state.stats.mined },
            { id: 'mine2', type: 'mining', text: "Excavator: Mine 30 Ores", target: 30, check: () => state.stats.mined },
            { id: 'mine3', type: 'mining', text: "Core Driller: Mine 100 Ores", target: 100, check: () => state.stats.mined },
            { id: 'pick1', type: 'mining', text: "Upgrade: Craft Iron Pick", target: 2, check: () => state.tools.pick },
            { id: 'visit_mine', type: 'mining', text: "Travel: Visit Mines", target: 1, check: () => state.unlocked.mine?1:0 },
            { id: 'visit_deep', type: 'mining', text: "Travel: Deep Dark", target: 1, check: () => state.unlocked.deep?1:0 },
            
            // Foraging
            { id: 'wood1', type: 'foraging', text: "Lumberjack: Chop 5 Logs", target: 5, check: () => state.stats.wood },
            { id: 'wood2', type: 'foraging', text: "Deforestation: Chop 50 Logs", target: 50, check: () => state.stats.wood },
            { id: 'visit_for', type: 'foraging', text: "Travel: Visit Forest", target: 1, check: () => state.unlocked.forest?1:0 },
            
            // Combat
            { id: 'kill1', type: 'combat', text: "Hunter: Defeat 5 Mobs", target: 5, check: () => state.stats.kills },
            { id: 'boss1', type: 'combat', text: "Slayer: Defeat Magma King", target: 1, check: () => state.unlocked.bossDefeated?1:0 }
        ];

        const achievementList = [
            { id: 'first_coin', icon: 'ü™ô', title: 'First Dollar', desc: 'Earn 100 Coins', check:()=>state.coins>=100, reward:{type:'coin', val:50, label:'50g'} },
            { id: 'rich', icon: 'üí∞', title: 'Rich & Famous', desc: 'Earn 5000 Coins', check:()=>state.coins>=5000, reward:{type:'unlock_seed', id:'solar', label:'Solar Seed'} },
            { id: 'harvester', icon: 'üöú', title: 'Green Thumb', desc: 'Harvest 50 Crops', check:()=>state.stats.harvests>=50, reward:{type:'coin', val:500, label:'500g'} },
            { id: 'killer', icon: '‚öîÔ∏è', title: 'Monster Hunter', desc: 'Kill 20 Mobs', check:()=>state.stats.kills>=20, reward:{type:'unlock_seed', id:'void', label:'Void Seed'} },
            { id: 'fisher', icon: 'üé£', title: 'Master Angler', desc: 'Catch 50 Fish', check:()=>state.stats.fish>=50, reward:{type:'coin', val:1000, label:'1000g'} },
            { id: 'miner', icon: '‚õèÔ∏è', title: 'Prospector', desc: 'Mine 100 Ores', check:()=>state.stats.mined>=100, reward:{type:'coin', val:800, label:'800g'} }
        ];
        
        // Helper to get total quest completion
        function isQuestComplete(q) { return q.check() >= q.target; }

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 20, 250);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new PointerLockControls(new THREE.Object3D(), document.body); // Dummy object
        
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6);
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
        dirLight.position.set(60, 100, 40);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.set(2048, 2048);
        scene.add(dirLight);

        const colliders = [];
        const interactables = [];
        const bridges = [];

        // --- WORLD GENERATION ---
        
        // 1. HOME
        createIsland(0, 0, 35, colors.grass, 'Home');
        createShop(0, 0, 0);
        createPlots(4, 'standard');

        // 2. RANCH
        createIsland(-70, 0, 30, colors.ranch, 'Ranch');
        createBridge(new THREE.Vector3(-25, -2, 0), new THREE.Vector3(-50, -2, 0), 'ranch');
        createPen(-70, 0);
        createBarn(-80, 5); 

        // 3. FOREST
        createIsland(-130, 0, 30, colors.forest, 'Forest');
        createBridge(new THREE.Vector3(-95, -2, 0), new THREE.Vector3(-110, -2, 0), 'forest');
        for(let i=0; i<6; i++) spawnTree(-130, 0, 25);

        // 4. MAGMA
        createIsland(70, 0, 30, colors.magma, 'Magma');
        createBridge(new THREE.Vector3(25, -2, 0), new THREE.Vector3(50, -2, 0), 'magma');
        createPlots(6, 'magma', 60, 0); 
        const volcano = new THREE.Mesh(new THREE.ConeGeometry(8, 15, 8), new THREE.MeshStandardMaterial({color:0x2d3436}));
        volcano.position.set(80, 5, -10); scene.add(volcano);
        const altar = new THREE.Mesh(new THREE.BoxGeometry(4,1,4), new THREE.MeshStandardMaterial({color:0x000000, emissive:0xff0000, emissiveIntensity:0.2}));
        altar.position.set(80, 0, 10);
        scene.add(altar);
        interactables.push({ type: 'altar', mesh: altar, radius: 5, label: 'SUMMON MAGMA BOSS (500g)' });

        // 5. DOCK
        createIsland(0, 80, 30, colors.sand, 'Dock');
        createBridge(new THREE.Vector3(0, -2, 30), new THREE.Vector3(0, -2, 55), 'dock');
        const water = new THREE.Mesh(new THREE.CylinderGeometry(40, 40, 5, 32), new THREE.MeshStandardMaterial({color: 0x0984e3, transparent: true, opacity: 0.8}));
        water.position.set(0, -3.5, 90); scene.add(water);
        const pier = new THREE.Mesh(new THREE.BoxGeometry(6, 0.5, 20), new THREE.MeshStandardMaterial({color: 0x8B4513}));
        pier.position.set(0, 0, 75); pier.receiveShadow = true; colliders.push(pier); scene.add(pier);
        
        // Lighthouse
        const lhGrp = new THREE.Group();
        const lhBase = new THREE.Mesh(new THREE.CylinderGeometry(2, 3, 10), new THREE.MeshStandardMaterial({color:0xffffff}));
        lhBase.position.y=5;
        const lhTop = new THREE.Mesh(new THREE.CylinderGeometry(2.5, 2.5, 2), new THREE.MeshStandardMaterial({color:0x2d3436}));
        lhTop.position.y=11;
        const lhLight = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 2), new THREE.MeshStandardMaterial({color:0xffff00, emissive:0xffff00}));
        lhLight.position.y=13;
        const lhRoof = new THREE.Mesh(new THREE.ConeGeometry(3, 2), new THREE.MeshStandardMaterial({color:0xff7675}));
        lhRoof.position.y=15;
        lhGrp.add(lhBase, lhTop, lhLight, lhRoof);
        lhGrp.position.set(15, -2, 80);
        scene.add(lhGrp); colliders.push(lhBase);

        // 6. MINE
        createIsland(0, -80, 35, colors.stone, 'Mine');
        createBridge(new THREE.Vector3(0, -2, -30), new THREE.Vector3(0, -2, -55), 'mine');
        const caveEntrance = new THREE.Mesh(new THREE.TorusGeometry(8, 2, 16, 32, Math.PI), new THREE.MeshStandardMaterial({color: 0x2d3436}));
        caveEntrance.position.set(0, 0, -90); scene.add(caveEntrance);
        for(let i=0; i<8; i++) spawnOre(0, -80, 30);
        for(let i=0; i<3; i++) spawnMob(0, -80, 25);

        // 7. SKY ISLAND
        const skyIsland = new THREE.Mesh(new THREE.CylinderGeometry(20, 15, 5, 7), new THREE.MeshStandardMaterial({color: colors.sky, transparent:true, opacity:0.9}));
        skyIsland.position.set(-50, 40, -50);
        skyIsland.receiveShadow = true; colliders.push(skyIsland); scene.add(skyIsland);
        for(let i=0; i<5; i++) {
            const plat = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 4), new THREE.MeshStandardMaterial({color:0xffffff}));
            plat.position.set(-20 - i*5, 5 + i*7, -10 - i*8); scene.add(plat); colliders.push(plat);
        }
        for(let i=0; i<3; i++) {
            const crystal = new THREE.Mesh(new THREE.OctahedronGeometry(1), new THREE.MeshStandardMaterial({color: 0xe056fd, emissive: 0xbe2edd, emissiveIntensity:0.5}));
            crystal.position.set(-50 + (Math.random()-0.5)*15, 43, -50 + (Math.random()-0.5)*15);
            scene.add(crystal);
            state.ores.push({mesh:crystal, val:500, hp:20, maxHp:20, active:true, name:"Sky Crystal"});
        }
        interactables.push({ type: 'sky_check', mesh: skyIsland, radius: 25, label: '' });

        // 8. DEEP DARK
        createIsland(0, -180, 45, colors.deep, 'Deep Dark');
        createBridge(new THREE.Vector3(0, -2, -115), new THREE.Vector3(0, -2, -135), 'deep');
        for(let i=0; i<8; i++) spawnOre(0, -180, 35, true); 
        for(let i=0; i<5; i++) spawnMob(0, -180, 35, true); 
        const altar2 = new THREE.Mesh(new THREE.BoxGeometry(4,1,4), new THREE.MeshStandardMaterial({color:0x2f3640, emissive:0x6c5ce7, emissiveIntensity:0.5}));
        altar2.position.set(0, 0, -200);
        scene.add(altar2);
        interactables.push({ type: 'altar2', mesh: altar2, radius: 5, label: 'SUMMON VOID GOLEM (1500g)' });

        // --- FUNCTIONS ---

        function createIsland(x, z, size, color, name) {
            const geo = new THREE.CylinderGeometry(size, size*0.8, 5, 8);
            const mat = new THREE.MeshStandardMaterial({ color: color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, -2.5, z);
            mesh.receiveShadow = true; scene.add(mesh); colliders.push(mesh);
        }

        function createBridge(start, end, id) {
            const len = start.distanceTo(end);
            const mid = start.clone().add(end).multiplyScalar(0.5);
            const geo = new THREE.BoxGeometry(len, 0.5, 5);
            const mesh = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({color: 0x8B4513}));
            if(Math.abs(start.z - end.z) > Math.abs(start.x - end.x)) mesh.rotation.y = Math.PI / 2;
            mesh.position.copy(mid); mesh.visible = false; scene.add(mesh);
            const holo = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({color: 0xff0000, wireframe:true, transparent:true, opacity:0.3}));
            holo.position.copy(mid); holo.rotation.copy(mesh.rotation); scene.add(holo);
            bridges.push({ id, mesh, holo, unlocked: false });
        }

        function createShop(x, y, z) {
            const geo = new THREE.IcosahedronGeometry(2.5);
            const mat = new THREE.MeshStandardMaterial({color: 0x6C5CE7, metalness: 0.8, roughness: 0.2});
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y+3, z-8); mesh.castShadow = true; scene.add(mesh);
            interactables.push({ type: 'shop', mesh, radius: 6, label: 'OPEN SHOP' });
            return mesh;
        }

        function createPlots(count, zone, startX=-10, startZ=8) {
            const mat = zone==='magma' ? new THREE.MeshStandardMaterial({color:0x442222}) : new THREE.MeshStandardMaterial({color:0x8B4513});
            const existing = state.plots.filter(p => p.zone === zone).length;
            const isMagma = zone === 'magma';

            for(let i=0; i<count; i++) {
                const idx = existing + i;
                const row = Math.floor(idx/2); 
                const col = idx%2;
                const xOff = isMagma ? 60 : -10;
                const zOff = isMagma ? 0 : 8;
                
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(3, 0.2, 3), mat.clone());
                mesh.position.set(xOff + col*4, 0.1, zOff + row*4);
                mesh.receiveShadow = true; scene.add(mesh);

                const plant = new THREE.Mesh(new THREE.DodecahedronGeometry(0.5), new THREE.MeshStandardMaterial({color:0x00ff00}));
                plant.position.y=0.5; plant.visible=false; mesh.add(plant);
                const spr = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.5), new THREE.MeshStandardMaterial({color:0x74b9ff}));
                spr.position.y=0.25; spr.visible=false; mesh.add(spr);

                state.plots.push({mesh, plant, spr, zone, status:'empty', hasSprinkler:false, type:null, timer:0});
                interactables.push({type:'plot', id:state.plots.length-1, mesh, radius:2.5});
            }
        }

        function createCollector(type, x, z) {
            const geo = new THREE.BoxGeometry(2, 2, 2);
            const mat = new THREE.MeshStandardMaterial({color: 0xdfe6e9, map: null});
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, 1, z); scene.add(mesh);
            
            const label = type==='farm' ? 'üöú' : 'üßπ';
            const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
            const ctx = canvas.getContext('2d'); ctx.font='40px Arial'; ctx.fillText(label, 10, 50);
            const tex = new THREE.CanvasTexture(canvas);
            const face = new THREE.Mesh(new THREE.PlaneGeometry(1.5,1.5), new THREE.MeshBasicMaterial({map:tex, transparent:true}));
            face.position.z = 1.01; mesh.add(face);

            state.collectors.push({ mesh, type, inventory: [], seeds: {} });
            interactables.push({ type: 'collector', mesh, radius: 4, id: state.collectors.length-1, label: 'E: LOOT BOX' });
        }

        function createPen(x, z) {
            const fence = new THREE.Group();
            for(let i=0; i<4; i++) {
                const post = new THREE.Mesh(new THREE.BoxGeometry(0.5,1.5,0.5), new THREE.MeshStandardMaterial({color:0xA0522D}));
                const angle = (i/4)*Math.PI*2 + Math.PI/4;
                post.position.set(Math.sin(angle)*5, 0.75, Math.cos(angle)*5); fence.add(post);
            }
            fence.position.set(x, 0, z); scene.add(fence); state.pens.push({x, z});
        }

        function createBarn(x, z) {
            const grp = new THREE.Group();
            // Body
            const body = new THREE.Mesh(new THREE.BoxGeometry(6, 4, 8), new THREE.MeshStandardMaterial({color: 0xd63031}));
            body.position.y = 2;
            // Roof
            const roof = new THREE.Mesh(new THREE.CylinderGeometry(0, 5, 9, 4, 1), new THREE.MeshStandardMaterial({color: 0x2d3436}));
            roof.rotation.y = Math.PI / 4; roof.rotation.x = Math.PI / 2; roof.position.y = 5.5;
            // Door
            const door = new THREE.Mesh(new THREE.PlaneGeometry(3, 3), new THREE.MeshStandardMaterial({color: 0x000000}));
            door.position.set(0, 1.5, 4.01);
            
            grp.add(body, roof, door);
            grp.position.set(x, 0, z);
            grp.rotation.y = -Math.PI / 4;
            scene.add(grp); colliders.push(body);
        }

        function spawnTree(cx, cz, radius) {
            const grp = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.8, 3), new THREE.MeshStandardMaterial({color:0x8B4513}));
            trunk.position.y=1.5;
            const leaves = new THREE.Mesh(new THREE.ConeGeometry(2.5, 5, 8), new THREE.MeshStandardMaterial({color:0x27ae60}));
            leaves.position.y=4;
            grp.add(trunk, leaves);
            
            const angle = Math.random() * Math.PI * 2; const dist = Math.random() * radius;
            grp.position.set(cx + Math.cos(angle)*dist, 0, cz + Math.sin(angle)*dist);
            scene.add(grp); colliders.push(trunk);
            state.trees.push({ mesh: grp, hp: 3, active: true, respawn: 0 });
        }

        function spawnOre(cx, cz, radius, isDeep=false) {
            const type = Math.random();
            let color = 0x636e72; let val = 15; let hp = 3; let name = "Stone";
            
            if(!isDeep) {
                if(type > 0.6) { color = 0xb2bec3; val=40; hp=5; name="Iron"; }
                if(type > 0.85) { color = 0xffd700; val=100; hp=8; name="Gold"; }
                if(type > 0.95) { color = 0x00cec9; val=300; hp=15; name="Diamond"; }
            } else {
                if(type > 0.5) { color = 0xb2bec3; val=40; hp=5; name="Iron"; }
                if(type > 0.7) { color = 0xffd700; val=100; hp=8; name="Gold"; }
                if(type > 0.85) { color = 0x00cec9; val=300; hp=15; name="Diamond"; }
                if(type > 0.95) { color = colors.titanium; val=800; hp=25; name="Titanium"; }
            }

            const mesh = new THREE.Mesh(new THREE.DodecahedronGeometry(1 + Math.random()), new THREE.MeshStandardMaterial({color: color}));
            const angle = Math.random() * Math.PI * 2; const dist = Math.random() * radius;
            mesh.position.set(cx + Math.cos(angle)*dist, 0.5, cz + Math.sin(angle)*dist);
            mesh.castShadow = true; scene.add(mesh);
            state.ores.push({ mesh, val, hp, maxHp: hp, active: true, name });
        }

        function spawnMob(cx, cz, radius, isDeep=false) {
            const type = isDeep ? (Math.random()>0.5 ? 'stalker' : 'golem') : (Math.random() > 0.5 ? 'golem' : 'bat');
            const grp = new THREE.Group();
            let hp, speed, dmg;

            if(type === 'golem') {
                const body = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshStandardMaterial({color: 0x2d3436}));
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshStandardMaterial({color: 0x636e72}));
                head.position.y = 1.2; grp.add(body, head);
                hp = 30; speed = 2.5; dmg = 15;
            } else if (type === 'bat') {
                const body = new THREE.Mesh(new THREE.SphereGeometry(0.6), new THREE.MeshStandardMaterial({color: 0x6c5ce7}));
                const wing = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.1, 0.5), new THREE.MeshStandardMaterial({color: 0x2d3436}));
                grp.add(body, wing); grp.position.y = 2;
                hp = 15; speed = 5; dmg = 5;
            } else if (type === 'stalker') {
                const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 2, 4, 8), new THREE.MeshStandardMaterial({color: 0x000000}));
                const eye = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color: 0xff0000}));
                eye.position.set(0, 0.5, 0.5); grp.add(body, eye);
                hp = 100; speed = 6; dmg = 30;
            }

            const angle = Math.random() * Math.PI * 2; const dist = Math.random() * radius;
            grp.position.set(cx + Math.cos(angle)*dist, 1, cz + Math.sin(angle)*dist);
            scene.add(grp);
            state.mobs.push({ mesh: grp, type, hp, maxHp: hp, speed, dmg, active: true, atkCooldown: 0 });
        }

        function spawnBoss() {
            if(state.boss.active) return;
            state.boss.active = true; state.boss.hp = 500; state.boss.maxHp = 500;
            const grp = new THREE.Group();
            const body = new THREE.Mesh(new THREE.IcosahedronGeometry(3, 1), new THREE.MeshStandardMaterial({color:0xff0000, wireframe:true}));
            const core = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshStandardMaterial({color:0xff7675, emissive:0xff0000}));
            grp.add(body, core);
            for(let i=0; i<3; i++) {
                const s = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:0x2d3436}));
                s.position.x = 4; const pivot = new THREE.Group(); pivot.rotation.y = (Math.PI*2/3)*i; pivot.add(s); grp.add(pivot);
            }
            grp.position.set(80, 5, 10); scene.add(grp); state.boss.mesh = grp;
            showToast("MAGMA KING SUMMONED!"); AudioSys.playTone(50, 'sawtooth', 2);
        }

        function spawnBoss2() {
            if(state.boss2.active) return;
            state.boss2.active = true; state.boss2.hp = 1200; state.boss2.maxHp = 1200;
            const grp = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(5, 6, 3), new THREE.MeshStandardMaterial({color:0x000000}));
            body.position.y = 3;
            const head = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({color:0x2f3640}));
            head.position.y = 7;
            const eye = new THREE.Mesh(new THREE.PlaneGeometry(1.5, 0.5), new THREE.MeshBasicMaterial({color:0x6c5ce7}));
            eye.position.set(0, 7, 1.01);
            
            grp.add(body, head, eye);
            grp.position.set(0, 5, -200); scene.add(grp); state.boss2.mesh = grp;
            showToast("VOID GOLEM SUMMONED!"); AudioSys.playTone(40, 'square', 2.5);
        }

        function spawnAnimal(type) {
            if(state.pens.length===0) return;
            const pen = state.pens[0];
            const group = new THREE.Group();
            const color = type==='chicken' ? 0xffffff : 0x55efc4;
            const body = new THREE.Mesh(type==='chicken'?new THREE.BoxGeometry(0.8,0.8,0.8):new THREE.SphereGeometry(0.5), new THREE.MeshStandardMaterial({color}));
            group.add(body);
            const eye = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1), new THREE.MeshBasicMaterial({color:0x000000}));
            const e1=eye.clone(); e1.position.set(0.2,0.3,0.3); const e2=eye.clone(); e2.position.set(-0.2,0.3,0.3); group.add(e1,e2);
            group.position.set(pen.x, 1, pen.z); scene.add(group);
            state.animals.push({ mesh: group, type, target: new THREE.Vector3(pen.x, 1, pen.z), produceTimer: 10 + Math.random()*5 });
            showToast(`New ${type} added!`);
        }

        // --- GAME LOGIC ---

        function showToast(msg) {
            const el = document.createElement('div'); el.className = 'toast'; el.innerText = msg;
            document.getElementById('notification-area').appendChild(el); setTimeout(()=>el.remove(), 2500);
        }

        function showFloatText(pos, msg, color='#fff') {
            const el = document.createElement('div'); el.className = 'float-text'; el.innerText = msg; el.style.color = color;
            const v = pos.clone(); v.project(camera);
            const x = (v.x * .5 + .5) * window.innerWidth; const y = (-(v.y * .5) + .5) * window.innerHeight;
            el.style.left = x + 'px'; el.style.top = y + 'px'; document.body.appendChild(el); setTimeout(()=>el.remove(), 1000);
        }

        function addToInventory(name, val, type) {
            const count = state.inventory.reduce((acc, item) => acc + item.count, 0);
            if(count >= state.maxInventory) { showToast("Bag Full!"); return false; }
            const existing = state.inventory.find(i => i.name === name);
            if(existing) existing.count++; else state.inventory.push({ name, val, count: 1, type });
            updateHUD(); return true;
        }

        function getResourceCount(name) {
            const item = state.inventory.find(i => i.name === name);
            return item ? item.count : 0;
        }

        function removeResource(name, qty) {
            const item = state.inventory.find(i => i.name === name);
            if(item && item.count >= qty) {
                item.count -= qty;
                if(item.count <= 0) state.inventory = state.inventory.filter(i=>i.name!==name);
                updateHUD(); return true;
            }
            return false;
        }

        // --- SHOP & CRAFTING & SETTINGS ---
        window.game = {
            openShop: () => {
                state.isShopOpen = true; document.getElementById('shop-menu').style.display = 'flex';
                controls.unlock(); game.setTab('upgrades'); updateHUD();
            },
            closeShop: () => {
                state.isShopOpen = false; document.getElementById('shop-menu').style.display = 'none'; controls.lock();
            },
            toggleSettings: () => {
                if(state.isSettingsOpen) game.closeSettings();
                else {
                    state.isSettingsOpen = true;
                    document.getElementById('settings-menu').style.display = 'flex';
                    controls.unlock();
                    game.renderSettings();
                }
            },
            closeSettings: () => {
                state.isSettingsOpen = false;
                document.getElementById('settings-menu').style.display = 'none';
                if(!state.isShopOpen) controls.lock();
            },
            openQuests: () => {
                game.toggleSettings();
                game.setSettingsTab('quests');
            },
            setSettingsTab: (t) => {
                state.currentSettingsTab = t;
                game.renderSettings();
            },
            recordKey: (action) => {
                state.bindRecording = action;
                game.renderSettings();
            },
            sellAll: () => {
                const total = state.inventory.reduce((a,b)=>a+(b.val*b.count), 0);
                if(total===0) return;
                state.coins += total; state.inventory = [];
                AudioSys.coin(); showToast(`Sold all for ${total} Coins!`); updateHUD(); game.renderShop();
            },
            setTab: (t) => {
                document.querySelectorAll('#shop-menu .tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active'); state.currentTab = t; game.renderShop();
            },
            buyId: (itemKey) => {
                const item = SHOP_DATA[itemKey];
                if(!item) return;
                
                // Dynamic Cost calculation (for bags)
                let finalCost = item.cost;
                if(item.dynamicCost && item.id==='bag') finalCost = 150 * state.lvl.bag;

                if(state.coins < finalCost) { showToast("Need more Coins!"); return; }
                
                if(item.mats) {
                    for(let m of item.mats) {
                        if(getResourceCount(m.name) < m.qty) {
                            showToast(`Missing: ${m.qty} ${m.name}`);
                            return;
                        }
                    }
                }

                state.coins -= finalCost;
                if(item.mats) for(let m of item.mats) removeResource(m.name, m.qty);
                AudioSys.buy();

                // Effect
                const cat = item.cat; const id = item.id;
                if(cat === 'upgrade') {
                    if(id==='bag') { state.lvl.bag++; state.maxInventory+=5; }
                    if(id==='sprinkler') {
                        const p = state.plots.find(p=>!p.hasSprinkler);
                        if(p) { p.hasSprinkler=true; p.spr.visible=true; showToast("Sprinkler Installed"); }
                    }
                    if(id==='boots') { state.upgrades.speed = 1; state.speed = 22; showToast("Speed Boost!"); }
                    if(id==='flight') { state.upgrades.flight = true; state.jumpForce = 25; showToast("Feather Acquired!"); }
                    if(id==='feeder') { state.upgrades.ranchSpeed = true; showToast("Auto-Feeder Installed!"); }
                }
                if(cat === 'collector') {
                    createCollector(id, id==='farm'?0:(id==='magma'?60:-70), 10);
                    showToast("Auto-Bot Deployed!");
                }
                if(cat === 'plot') { createPlots(2, 'standard'); showToast("Farm Expanded!"); }
                if(cat === 'seed') state.seeds[id]++;
                if(cat === 'animal') spawnAnimal(id); // itemKey is usually 'chicken', special case in render needed
                if(cat === 'rod') { state.tools.rod = id; showToast("Rod Upgraded!"); }
                if(cat === 'pick') { state.tools.pick = id; showToast("Pickaxe Crafted!"); }
                if(cat === 'sword') { state.tools.sword = id; showToast("Sword Crafted!"); }
                if(cat === 'axe') { state.tools.axe = id; showToast("Axe Crafted!"); }
                if(cat === 'potion') { state.hp = Math.min(state.hp + 50, state.maxHp); showToast("Healed!"); }
                if(cat === 'permit') { state.unlocked[id] = true; showToast("AREA UNLOCKED!"); }

                updateHUD(); game.renderShop();
            },
            saveGame: () => {
                const saveData = {
                    coins: state.coins, lvl: state.lvl, tools: state.tools, upgrades: state.upgrades,
                    unlocked: state.unlocked, seeds: state.seeds, stats: state.stats, inventory: state.inventory,
                    achievements: state.achievements,
                    plots: state.plots.map(p => ({ status: p.status, type: p.type, timer: p.timer, hasSprinkler: p.hasSprinkler, zone: p.zone })),
                    collectors: state.collectors.map(c => ({ type: c.type, inv: c.inventory, seeds: c.seeds })),
                    blocks: state.builtBlocks.map(b => ({x:b.position.x, y:b.position.y, z:b.position.z})),
                    settings: { volSfx: AudioSys.vol.sfx, volMusic: AudioSys.vol.music, sens: state.sensitivity, keys: state.keybinds }
                };
                localStorage.setItem('skyboundForageSaveV2', JSON.stringify(saveData)); showToast("GAME SAVED!");
            },
            loadGame: () => {
                const dataStr = localStorage.getItem('skyboundForageSaveV2');
                if(!dataStr) { showToast("No Save Found"); return; }
                const data = JSON.parse(dataStr);
                state.coins = data.coins; state.lvl = data.lvl; state.tools = data.tools;
                state.upgrades = data.upgrades || {flight:false, speed:0, ranchSpeed:false}; state.unlocked = data.unlocked;
                state.seeds = data.seeds; state.stats = data.stats || { harvests: 0, kills: 0, fish: 0, mined: 0, wood:0 };
                state.inventory = data.inventory || []; state.maxInventory = 10 + (state.lvl.bag-1)*5;
                state.achievements = data.achievements || [];

                // Load Settings
                if(data.settings) {
                    AudioSys.vol.sfx = data.settings.volSfx;
                    AudioSys.vol.music = data.settings.volMusic;
                    state.sensitivity = data.settings.sens;
                    if(data.settings.keys) state.keybinds = data.settings.keys;
                }

                if(state.upgrades.speed) state.speed = 22; if(state.upgrades.flight) state.jumpForce = 25;

                state.plots.forEach(p => scene.remove(p.mesh)); state.plots = [];
                for(let i=interactables.length-1; i>=0; i--) if(interactables[i].type==='plot') interactables.splice(i,1);

                if(data.plots && data.plots.length > 0) {
                    let std = data.plots.filter(p=>p.zone!=='magma').length;
                    let mag = data.plots.filter(p=>p.zone==='magma').length;
                    createPlots(std, 'standard'); createPlots(mag, 'magma', 60, 0);
                    data.plots.forEach((pData, i) => {
                        if(state.plots[i]) {
                            const p = state.plots[i];
                            p.status = pData.status; p.type = pData.type; p.timer = pData.timer; 
                            p.hasSprinkler = pData.hasSprinkler; p.spr.visible = p.hasSprinkler;
                            if(p.status === 'growing' || p.status === 'ready') {
                                p.plant.visible = true;
                                const cols = { carrot:0xffa502, star:0xffff00, moon:0x74b9ff, lava:0xff7675, solar:0xf1c40f, void:0x2c3e50 };
                                p.plant.material.color.setHex(cols[p.type] || 0x00ff00);
                            }
                        }
                    });
                } else { createPlots(4, 'standard'); createPlots(6, 'magma', 60, 0); }
                
                state.collectors.forEach(c => scene.remove(c.mesh)); state.collectors = [];
                for(let i=interactables.length-1; i>=0; i--) if(interactables[i].type==='collector') interactables.splice(i,1);
                
                if(data.collectors) {
                    data.collectors.forEach(c => {
                        createCollector(c.type, c.type==='farm'?0:(c.type==='magma'?60:-70), 10);
                        const newC = state.collectors[state.collectors.length-1];
                        newC.inventory = c.inv || []; newC.seeds = c.seeds || {};
                    });
                }

                if(data.blocks) {
                    state.builtBlocks.forEach(b => scene.remove(b)); state.builtBlocks = [];
                    data.blocks.forEach(pos => placeBlockAt(new THREE.Vector3(pos.x, pos.y, pos.z)));
                }
                showToast("GAME LOADED!"); updateHUD(); document.getElementById('blocker').style.display='none'; controls.lock();
            },
            renderSettings: () => {
                const c = document.getElementById('settings-content'); c.innerHTML = '';
                const tab = state.currentSettingsTab;
                
                document.querySelectorAll('#settings-menu .tab-btn').forEach(b => b.classList.remove('active'));
                const btnIdx = ['quests','achievements','settings','controls'].indexOf(tab);
                if(btnIdx>=0) document.querySelectorAll('#settings-menu .tab-btn')[btnIdx].classList.add('active');

                if(tab === 'quests') {
                    const cats = ['Active', 'Fishing', 'Mining', 'Foraging', 'Farming', 'Combat', 'General'];
                    cats.forEach(cat => {
                        const list = questList.filter(q => {
                            if(cat==='Active') return !isQuestComplete(q) && (q.type==='general' || q.type==='farming');
                            return q.type.toLowerCase() === cat.toLowerCase();
                        });
                        if(list.length > 0) {
                            c.innerHTML += `<h3 style="margin-bottom:5px; border-bottom:2px solid #ccc;">${cat}</h3>`;
                            list.forEach(q => {
                                const prog = q.check();
                                const pct = Math.min(100, (prog/q.target)*100);
                                const isDone = prog >= q.target;
                                c.innerHTML += `
                                <div class="quest-card ${isDone?'complete':''}">
                                    <div style="display:flex; justify-content:space-between;">
                                        <strong>${q.text}</strong>
                                        <span>${prog}/${q.target}</span>
                                    </div>
                                    <div class="quest-prog"><div class="quest-fill" style="width:${pct}%"></div></div>
                                </div>`;
                            });
                        }
                    });
                }
                else if(tab === 'achievements') {
                    achievementList.forEach(ach => {
                        const claimed = state.achievements.includes(ach.id);
                        const unlocked = ach.check();
                        // Claim logic
                        if(unlocked && !claimed) {
                            state.achievements.push(ach.id);
                            if(ach.reward.type==='coin') state.coins += ach.reward.val;
                            // Seeds are checked in shop
                            AudioSys.win(); showToast("Achievement: " + ach.title);
                        }
                        const isClaimed = state.achievements.includes(ach.id);
                        
                        c.innerHTML += `
                        <div class="ach-card ${!isClaimed ? 'locked' : ''}">
                            <div class="ach-icon">${ach.icon}</div>
                            <div class="ach-info">
                                <div style="font-weight:bold;">${ach.title}</div>
                                <div style="font-size:12px;">${ach.desc}</div>
                            </div>
                            <div class="ach-reward">${ach.reward.label}</div>
                        </div>`;
                    });
                }
                else if(tab === 'settings') {
                    c.innerHTML = `
                        <div class="setting-row">
                            <span class="setting-label">Music Volume</span>
                            <input type="range" min="0" max="1" step="0.1" value="${AudioSys.vol.music}" oninput="AudioSys.vol.music=this.value">
                        </div>
                        <div class="setting-row" style="margin-top:10px;">
                            <span class="setting-label">SFX Volume</span>
                            <input type="range" min="0" max="1" step="0.1" value="${AudioSys.vol.sfx}" oninput="AudioSys.vol.sfx=this.value">
                        </div>
                        <div class="setting-row" style="margin-top:10px;">
                            <span class="setting-label">Mouse Sensitivity</span>
                            <input type="range" min="0.1" max="3" step="0.1" value="${state.sensitivity}" oninput="state.sensitivity=parseFloat(this.value)">
                        </div>
                    `;
                }
                else if(tab === 'controls') {
                    const keys = {f:'Move Forward', b:'Move Back', l:'Move Left', r:'Move Right', jump:'Jump', interact:'Interact'};
                    for(let k in keys) {
                        const isRec = state.bindRecording === k;
                        c.innerHTML += `
                        <div class="setting-row" style="margin-top:5px;">
                            <span>${keys[k]}</span>
                            <button class="keybind-btn ${isRec?'recording':''}" onclick="game.recordKey('${k}')">
                                ${isRec ? 'Press Key...' : state.keybinds[k]}
                            </button>
                        </div>`;
                    }
                }
            },
            renderShop: () => {
                const c = document.getElementById('shop-content'); c.innerHTML = '';
                const tab = state.currentTab;

                const addCard = (key) => {
                    const item = SHOP_DATA[key];
                    if(!item) return;

                    // Visibility checks for unlocked seeds
                    if(item.id === 'solar' && !state.achievements.includes('rich')) return;
                    if(item.id === 'void' && !state.achievements.includes('killer')) return;

                    // Condition checks
                    let purchased = false;
                    // Check if already bought one-time items
                    if(item.cat==='upgrade' && item.id!=='bag' && item.id!=='hp') {
                        if((item.id==='sprinkler' && state.plots.every(p=>p.hasSprinkler)) ||
                           (item.id==='boots' && state.upgrades.speed) ||
                           (item.id==='flight' && state.upgrades.flight) ||
                           (item.id==='feeder' && state.upgrades.ranchSpeed)) purchased = true;
                    }
                    if(item.cat==='permit' && state.unlocked[item.id]) purchased = true;
                    if(item.cat==='pick' && state.tools.pick >= item.id) purchased = true;
                    if(item.cat==='axe' && state.tools.axe >= item.id) purchased = true;
                    if(item.cat==='sword' && state.tools.sword >= item.id) purchased = true;
                    if(item.cat==='rod' && state.tools.rod >= item.id) purchased = true;

                    // Cost Logic
                    let cost = item.cost;
                    if(item.dynamicCost && item.id==='bag') cost = 150 * state.lvl.bag;

                    let matStr = "";
                    let canBuy = state.coins >= cost;
                    if(item.mats) {
                        matStr = item.mats.map(m=>`<span style="color:${getResourceCount(m.name)>=m.qty?'green':'red'}">${m.qty} ${m.name}</span>`).join(', ');
                        if(matStr) matStr = '<br><small>Req: ' + matStr + '</small>';
                        if(!item.mats.every(m=>getResourceCount(m.name)>=m.qty)) canBuy = false;
                    }
                    
                    const d = document.createElement('div'); d.className='item-card';
                    d.innerHTML = `<div><h3>${item.name}</h3></div><p>${item.desc}${matStr}</p>
                    <button class="buy-btn" onclick="game.buyId('${key}')" ${(!canBuy || purchased)?'disabled':''}>
                        ${purchased ? 'OWNED' : 'Buy ' + cost + ' üí∞'}
                    </button>`;
                    c.appendChild(d);
                };

                if(tab==='upgrades') {
                    addCard('bag_up'); addCard('sprinkler'); addCard('feeder'); addCard('boots'); addCard('flight'); addCard('potion');
                }
                if(tab==='farming') {
                    addCard('plot_deed'); addCard('seed_carrot'); addCard('seed_star'); addCard('seed_moon');
                    if(state.unlocked.magma) addCard('seed_lava');
                    // Secret Seeds
                    if(state.achievements.includes('rich')) addCard('seed_solar');
                    if(state.achievements.includes('killer')) addCard('seed_void');
                }
                if(tab==='forge') {
                    if(state.tools.axe < 1) addCard('axe_1');
                    if(state.tools.pick < 1) addCard('pick_1');
                    if(state.tools.pick < 2) addCard('pick_2');
                    if(state.tools.sword < 2) addCard('sword_2');
                    if(state.tools.pick < 3) addCard('pick_3');
                    if(state.tools.sword < 3) addCard('sword_3');
                    if(state.tools.pick < 4) addCard('pick_4');
                }
                if(tab==='automation') {
                    addCard('auto_farm'); addCard('auto_ranch'); addCard('auto_magma');
                }
                if(tab==='fishing') {
                    if(state.unlocked.dock) {
                        if(state.tools.rod < 1) addCard('rod_1');
                        if(state.tools.rod < 2) addCard('rod_2');
                        if(state.tools.rod < 3) addCard('rod_3');
                    } else c.innerHTML = '<h3 style="color:#aaa">Unlock Dock First</h3>';
                }
                if(tab==='permits') {
                    addCard('perm_ranch'); addCard('perm_forest'); addCard('perm_magma'); addCard('perm_dock'); addCard('perm_mine'); addCard('perm_deep');
                }
                if(tab==='ranch') {
                    // Manual animals for shop logic simplicity
                    // Not in SHOP_DATA for now as they trigger direct spawns without unique IDs really
                    const d = document.createElement('div'); d.className='item-card';
                    let can = state.coins >= 50;
                    d.innerHTML = `<h3>Chicken</h3><p>Lays Eggs</p><button class="buy-btn" onclick="game.buy('animal','chicken',50)" ${!can?'disabled':''}>Buy 50 üí∞</button>`;
                    c.appendChild(d);
                    const d2 = document.createElement('div'); d2.className='item-card';
                    let can2 = state.coins >= 150;
                    d2.innerHTML = `<h3>Slime</h3><p>Drops Goo</p><button class="buy-btn" onclick="game.buy('animal','slime',150)" ${!can2?'disabled':''}>Buy 150 üí∞</button>`;
                    c.appendChild(d2);
                }
                document.getElementById('sell-val').innerText = state.inventory.reduce((a,b)=>a+(b.val*b.count),0);
            }
        };

        // --- INTERACTION ---
        function handleInteract() {
            const p = camera.position; 
            let target = null, minDist = 100;
            interactables.forEach(o => {
                const d = p.distanceTo(o.mesh.position);
                if(d < o.radius && d < minDist) { minDist = d; target = o; }
            });

            if(target) {
                if(target.type === 'shop') game.openShop();
                if(target.type === 'plot') handlePlot(target.id);
                if(target.type === 'altar') {
                    if(state.coins >= 500) { state.coins -= 500; spawnBoss(); updateHUD(); } else showToast("Need 500 Coins!");
                }
                if(target.type === 'altar2') {
                    if(state.coins >= 1500) { state.coins -= 1500; spawnBoss2(); updateHUD(); } else showToast("Need 1500 Coins!");
                }
                if(target.type === 'sky_check') { if(state.upgrades.flight) state.unlocked.sky = true; }
                if(target.type === 'collector') handleCollector(target.id);
            }
        }

        function handleCollector(id) {
            const c = state.collectors[id];
            let lootCount = 0;
            // Loot Box
            c.inventory.forEach(item => {
                addToInventory(item.name, item.val, 'collected');
                lootCount++;
            });
            c.inventory = [];
            
            // Deposit Seeds
            if(c.type === 'farm' || c.type === 'magma') {
                const sKey = c.type === 'magma' ? 'lava' : 'carrot'; // Simplified seed logic
                // Take half of player's seeds
                for(let k in state.seeds) {
                    if(state.seeds[k] > 0) {
                        c.seeds[k] = (c.seeds[k]||0) + state.seeds[k];
                        state.seeds[k] = 0;
                        showToast(`Deposited ${k} seeds`);
                    }
                }
            }
            if(lootCount > 0) { AudioSys.coin(); showToast(`Collected ${lootCount} items`); }
            else showToast("Box is empty / Seeds Deposited");
        }

        function handleAction() {
            if(state.isShopOpen || state.isSettingsOpen) return;

            if(state.equipped === 'build') {
                if(state.coins < 10) { showToast("Block costs 10g"); return; }
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
                const hits = ray.intersectObjects([...colliders, ...state.builtBlocks]);
                if(hits.length > 0 && hits[0].distance < 8) {
                    const point = hits[0].point.clone().add(hits[0].face.normal.multiplyScalar(0.5));
                    point.x = Math.round(point.x); point.y = Math.round(point.y); point.z = Math.round(point.z);
                    placeBlockAt(point); state.coins -= 10; AudioSys.build(); updateHUD();
                }
            }
            if(state.equipped === 'axe') {
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
                // Check trees (trunk is children[0])
                const hits = ray.intersectObjects(state.trees.map(t=>t.mesh.children[0]));
                if(hits.length > 0 && hits[0].distance < 4) {
                    const tree = state.trees.find(t => t.mesh.children[0] === hits[0].object);
                    if(tree && tree.active) {
                        tree.hp--; AudioSys.wood(); showFloatText(hits[0].point, "-1");
                        tree.mesh.rotation.z = Math.sin(Date.now())*0.1;
                        if(tree.hp <= 0) {
                            tree.active = false; tree.mesh.visible = false; tree.respawn = 30;
                            addToInventory('Wood', 5, 'mat'); showToast("Got Wood!"); state.stats.wood++;
                        }
                    }
                }
                document.getElementById('tool-icon').style.transform = "rotate(-45deg)";
                setTimeout(()=>document.getElementById('tool-icon').style.transform = "rotate(0deg)", 100);
            }
            if(state.equipped === 'pick') {
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
                const hits = ray.intersectObjects(state.ores.map(o=>o.mesh));
                if(hits.length > 0 && hits[0].distance < 4) {
                    const ore = state.ores.find(o => o.mesh === hits[0].object);
                    if(ore && ore.active) {
                        const lv = state.tools.pick;
                        let canMine = false;
                        if(ore.name==='Stone' && lv>=1) canMine=true;
                        if(ore.name==='Iron' && lv>=1) canMine=true;
                        if(ore.name==='Gold' && lv>=2) canMine=true;
                        if(ore.name==='Diamond' && lv>=3) canMine=true;
                        if(ore.name==='Sky Crystal' && lv>=3) canMine=true;
                        if(ore.name==='Titanium' && lv>=4) canMine=true;
                        
                        if(canMine) {
                            ore.hp--; AudioSys.clank(); showFloatText(hits[0].point, "-1");
                            ore.mesh.scale.setScalar(0.9); setTimeout(()=>ore.mesh.scale.setScalar(1), 100);
                            if(ore.hp <= 0) {
                                ore.active = false; ore.mesh.visible = false; ore.respawn = 20; 
                                addToInventory(ore.name, ore.val, 'ore'); showToast(`Mined ${ore.name}!`); state.stats.mined++;
                            }
                        } else showToast("Pickaxe too weak!");
                    }
                }
            }
            if(state.equipped === 'sword') {
                const ray = new THREE.Raycaster(); ray.setFromCamera(new THREE.Vector2(0,0), camera);
                const hits = ray.intersectObjects(scene.children, true);
                let hitMob = null; let hitBoss = 0; // 0=none, 1=magma, 2=void
                for(let h of hits) {
                    if(h.distance > 5) continue;
                    let p = h.object; while(p.parent && p.parent !== scene) p = p.parent;
                    const mob = state.mobs.find(m => m.mesh === p);
                    if(mob && mob.active) { hitMob = mob; break; }
                    if(state.boss.active && state.boss.mesh === p) { hitBoss = 1; break; }
                    if(state.boss2.active && state.boss2.mesh === p) { hitBoss = 2; break; }
                }
                if(hitMob || hitBoss) {
                    let dmg = [0, 5, 12, 30][state.tools.sword];
                    AudioSys.hit();
                    if(hitMob) {
                        hitMob.hp -= dmg; showFloatText(hits[0].point, dmg);
                        hitMob.mesh.position.add(hitMob.mesh.position.clone().sub(camera.position).normalize().multiplyScalar(2));
                        if(hitMob.hp <= 0) {
                            hitMob.active = false; hitMob.mesh.visible = false; hitMob.respawn = 15;
                            // Drop logic
                            let drop='Mob Drop'; let val=10;
                            if(hitMob.type==='golem') { drop='Golem Core'; val=100; }
                            if(hitMob.type==='bat') { drop='Bat Wing'; val=60; }
                            if(hitMob.type==='stalker') { drop='Void Essence'; val=300; }
                            
                            addToInventory(drop, val, 'mob');
                            showToast("Defeated!"); state.stats.kills++;
                        }
                    }
                    if(hitBoss === 1) {
                        state.boss.hp -= dmg; showFloatText(hits[0].point, dmg);
                        state.boss.mesh.children[1].material.emissiveIntensity = 5;
                        setTimeout(()=>state.boss.mesh.children[1].material.emissiveIntensity=1, 100);
                        if(state.boss.hp <= 0) {
                            state.boss.active = false; scene.remove(state.boss.mesh);
                            state.unlocked.bossDefeated = true; state.coins += 2000; showToast("MAGMA KING DEFEATED! +2000 COINS");
                        }
                    }
                    if(hitBoss === 2) {
                        state.boss2.hp -= dmg; showFloatText(hits[0].point, dmg);
                        state.boss2.mesh.children[2].material.color.setHex(0xffffff);
                        setTimeout(()=>state.boss2.mesh.children[2].material.color.setHex(0x6c5ce7), 100);
                        if(state.boss2.hp <= 0) {
                            state.boss2.active = false; scene.remove(state.boss2.mesh);
                            state.coins += 5000; showToast("VOID GOLEM DEFEATED! +5000 COINS");
                            addToInventory("Void Heart", 5000, 'artifact');
                        }
                    }
                }
            }
        }

        function placeBlockAt(pos) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0x636e72}));
            mesh.position.copy(pos); scene.add(mesh); state.builtBlocks.push(mesh);
        }

        function handlePlot(id) {
            if(state.equipped !== 'hands') { showToast("Equip Hands [1]"); return; }
            const plot = state.plots[id];
            if(plot.status === 'empty') {
                if(plot.zone === 'magma') {
                    if(state.seeds.lava > 0) { state.seeds.lava--; plant(plot, 'lava', 0xff7675, 20); }
                } else {
                    if(state.seeds.void > 0) { state.seeds.void--; plant(plot, 'void', 0x2c3e50, 25); }
                    else if(state.seeds.solar > 0) { state.seeds.solar--; plant(plot, 'solar', 0xf1c40f, 20); }
                    else if(state.seeds.moon > 0) { state.seeds.moon--; plant(plot, 'moon', 0x74b9ff, 15); }
                    else if(state.seeds.star > 0) { state.seeds.star--; plant(plot, 'star', 0xffff00, 10); }
                    else if(state.seeds.carrot > 0) { state.seeds.carrot--; plant(plot, 'carrot', 0xffa502, 5); }
                    else showToast("No Seeds!");
                }
            } else if(plot.status === 'ready') {
                plot.status = 'empty'; plot.plant.visible = false;
                const vals = { carrot:30, star:100, moon:300, lava:600, solar:500, void:800 };
                if(addToInventory(plot.type, vals[plot.type], 'crop')) {
                    AudioSys.pop(); showToast(`Harvested ${plot.type}!`); state.stats.harvests++;
                }
            }
            updateHUD();
        }

        function plant(p, type, color, time) {
            p.status = 'growing'; p.type = type; p.timer = time; p.maxTime = time;
            p.plant.material.color.setHex(color); p.plant.visible = true; p.plant.scale.set(0.1,0.1,0.1);
            AudioSys.pop();
        }

        // --- NEW FISHING SYSTEM INTEGRATION ---
        
        function handleFishingClick() {
            if(state.equipped !== 'rod') return;
            const pos = camera.position;
            if(pos.z < 60) { showToast("Go to the Docks!"); return; }

            if(state.fishing.state === 'IDLE') {
                state.fishing.active = true;
                state.fishing.state = 'WAITING';
                state.fishing.timer = 2 + Math.random() * 3;
                state.fishing.bobber = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshStandardMaterial({color:0xff0000}));
                state.fishing.bobber.position.set(pos.x, -3, pos.z + 10);
                scene.add(state.fishing.bobber);
                showToast("Casted Line... Wait for it...");
            } else if (state.fishing.state === 'HOOKED') {
                startReelingMinigame();
            }
        }

        function startReelingMinigame() {
            controls.unlock(); 
            state.fishing.state = 'REELING';
            state.fishing.progress = 30;
            state.fishing.barPos = 0;
            state.fishing.fishPos = 10;
            state.fishing.fishTimer = 0;
            document.getElementById('reaction-cue').style.display = 'none';
            document.getElementById('fishing-overlay').style.display = 'flex';
        }

        document.addEventListener('mousemove', (e) => {
            if(state.fishing.state === 'REELING') {
                const container = document.getElementById('water-column');
                const rect = container.getBoundingClientRect();
                let relativeY = e.clientY - rect.top;
                let percent = 100 - (relativeY / rect.height * 100);
                const barHeightPercent = (100 / rect.height) * 100; 
                percent = percent - (barHeightPercent/2);
                if(percent < 0) percent = 0;
                if(percent > (100 - barHeightPercent)) percent = (100 - barHeightPercent);
                state.fishing.barPos = percent;
            } else if (controls.isLocked) {
                // Manual look handling for sensitivity
                const euler = new THREE.Euler(0, 0, 0, 'YXZ');
                euler.setFromQuaternion(camera.quaternion);
                
                euler.y -= e.movementX * 0.002 * state.sensitivity;
                euler.x -= e.movementY * 0.002 * state.sensitivity;
                euler.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, euler.x));
                
                camera.quaternion.setFromEuler(euler);
            }
        });

        function updateFishingMinigame(delta) {
            state.fishing.fishTimer++;
            if(state.fishing.fishTimer > 80) { 
                state.fishing.fishTimer = 0;
                state.fishing.fishTarget = Math.random() * 85;
            }
            let diff = state.fishing.fishTarget - state.fishing.fishPos;
            state.fishing.fishPos += diff * 0.03;
            state.fishing.fishPos += Math.sin(Date.now() / 300) * 0.2; 
            const barH = 30; const fishH = 10;
            const barBottom = state.fishing.barPos;
            const barTop = state.fishing.barPos + barH;
            const fishCenter = state.fishing.fishPos + (fishH/2);
            const isCatching = (fishCenter >= barBottom && fishCenter <= barTop);
            const catchBar = document.getElementById('catch-bar');
            
            if(isCatching) {
                catchBar.style.backgroundColor = "rgba(124, 252, 0, 0.7)";
                state.fishing.progress += 30 * delta; 
            } else {
                catchBar.style.backgroundColor = "rgba(124, 252, 0, 0.2)";
                state.fishing.progress -= 15 * delta;
            }
            state.fishing.progress = Math.max(0, Math.min(100, state.fishing.progress));
            catchBar.style.bottom = state.fishing.barPos + '%';
            document.getElementById('fish-target').style.bottom = state.fishing.fishPos + '%';
            document.getElementById('progress-fill').style.height = state.fishing.progress + '%';
            if(state.fishing.progress >= 100) finishFishing(true);
            else if(state.fishing.progress <= 0) finishFishing(false);
        }

        function finishFishing(win) {
            state.fishing.state = 'FINISHED';
            document.getElementById('fishing-overlay').style.display = 'none';
            if(win) {
                const types = ['Old Boot', 'Goldfish', 'Neon Tetra', 'Void Shark'];
                const vals = [5, 50, 150, 500];
                let t = 0; const r = Math.random();
                if(state.tools.rod >= 1 && r > 0.3) t=1;
                if(state.tools.rod >= 2 && r > 0.7) t=2;
                if(state.tools.rod >= 3 && r > 0.9) t=3;
                addToInventory(types[t], vals[t], 'fish');
                showToast(`CAUGHT: ${types[t]}!`);
                AudioSys.splash();
                state.stats.fish++;
            } else { showToast("It got away..."); }
            resetFishing();
        }

        function resetFishing() {
            state.fishing.active = false;
            state.fishing.state = 'IDLE';
            if(state.fishing.bobber) { scene.remove(state.fishing.bobber); state.fishing.bobber=null; }
            document.getElementById('reaction-cue').style.display = 'none';
            document.getElementById('fishing-overlay').style.display = 'none';
        }

        function updateHUD() {
            document.getElementById('ui-coins').innerText = state.coins;
            const bagCount = state.inventory.reduce((a,b)=>a+b.count,0);
            document.getElementById('ui-bag').innerText = bagCount;
            document.getElementById('ui-max').innerText = state.maxInventory;
            document.getElementById('tool-name').innerText = state.equipped.toUpperCase();
            const icons = { hands:'üß§', rod:'üé£', pick:'‚õèÔ∏è', sword:'‚öîÔ∏è', axe:'ü™ì', build:'üî®' };
            document.getElementById('tool-icon').innerText = icons[state.equipped];
            document.getElementById('health-fill').style.width = ((state.hp / state.maxHp) * 100) + '%';

            // Find an active general quest or fallback
            const activeQ = questList.find(q => !isQuestComplete(q));
            if(activeQ) {
                document.getElementById('quest-text').innerText = `${activeQ.text} (${Math.min(activeQ.check(), activeQ.target)}/${activeQ.target})`;
            } else document.getElementById('quest-text').innerText = "All Quests Complete!";

            const p = camera.position;
            let show = false, msg = "";
            interactables.forEach(o => {
                if(p.distanceTo(o.mesh.position) < o.radius) {
                    show = true;
                    if(o.type==='shop') msg="E: SHOP";
                    if(o.type==='altar') msg=o.label;
                    if(o.type==='altar2') msg=o.label;
                    if(o.type==='collector') msg=o.label;
                    if(o.type==='plot') {
                        const pl = state.plots[o.id];
                        msg = pl.status==='empty' ? "E: PLANT" : (pl.status==='ready' ? "E: HARVEST" : "Growing...");
                    }
                }
            });
            const el = document.getElementById('interact-msg');
            if(show) { el.style.display='block'; el.innerText=msg; } else el.style.display='none';
        }

        function playerDie() {
            state.hp = state.maxHp; camera.position.set(0, 5, 0);
            state.coins = Math.floor(state.coins * 0.8); showToast("YOU DIED! Lost coins."); AudioSys.playTone(100, 'sawtooth', 1);
        }

        document.getElementById('start-btn').onclick = () => { controls.lock(); AudioSys.ctx.resume(); };
        controls.addEventListener('lock', () => document.getElementById('blocker').style.display='none');
        controls.addEventListener('unlock', () => { 
            if(!state.isShopOpen && !state.isSettingsOpen && state.fishing.state !== 'REELING') 
                document.getElementById('blocker').style.display='flex'; 
        });

        const player = { velocity: new THREE.Vector3(), onGround: false };
        let move = { f: false, b: false, l: false, r: false };

        document.addEventListener('keydown', (e) => {
            if(e.code === 'Tab') { e.preventDefault(); game.toggleSettings(); return; }

            if(state.bindRecording) {
                state.keybinds[state.bindRecording] = e.code;
                state.bindRecording = null;
                game.renderSettings();
                return;
            }

            if(e.code===state.keybinds.f) move.f=true; 
            if(e.code===state.keybinds.b) move.b=true;
            if(e.code===state.keybinds.l) move.l=true; 
            if(e.code===state.keybinds.r) move.r=true;
            if(e.code===state.keybinds.jump && player.onGround) player.velocity.y = state.jumpForce;
            if(e.code===state.keybinds.interact) handleInteract();
            
            if(e.code==='KeyM') game.toggleSettings(); // Legacy key

            if(e.code==='Digit1') { state.equipped='hands'; resetFishing(); updateHUD(); }
            if(e.code==='Digit2') { state.equipped='rod'; updateHUD(); }
            if(e.code==='Digit3') { state.equipped='pick'; resetFishing(); updateHUD(); }
            if(e.code==='Digit4') { state.equipped='sword'; resetFishing(); updateHUD(); }
            if(e.code==='Digit5') { state.equipped='axe'; resetFishing(); updateHUD(); }
            if(e.code==='Digit6') { state.equipped='build'; resetFishing(); updateHUD(); showToast("Build: Left Click (10g)"); }
        });
        document.addEventListener('keyup', (e) => {
            if(e.code===state.keybinds.f) move.f=false; 
            if(e.code===state.keybinds.b) move.b=false;
            if(e.code===state.keybinds.l) move.l=false; 
            if(e.code===state.keybinds.r) move.r=false;
        });
        
        document.addEventListener('mousedown', () => {
            if(state.fishing.state === 'REELING') return; 
            if(controls.isLocked) {
                if(state.equipped==='rod') handleFishingClick();
                if(['pick','sword','axe','build'].includes(state.equipped)) handleAction();
            }
        });

        const clock = new THREE.Clock();
        const animalDrops = [];
        let autoTimer = 0;

        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(clock.getDelta(), 0.1);
            
            MusicSys.update(delta);

            bridges.forEach(b => {
                if(state.unlocked[b.id] && !b.unlocked) {
                    b.mesh.visible=true; b.holo.visible=false; colliders.push(b.mesh); b.unlocked=true;
                }
            });

            if(state.fishing.state === 'REELING') { updateFishingMinigame(delta); }

            if(controls.isLocked) {
                // Ground Check Raycast Improvement
                const rayOrigin = camera.position.clone();
                rayOrigin.y -= 1.0; 
                const ray = new THREE.Raycaster(rayOrigin, new THREE.Vector3(0, -1, 0), 0, 1.2);
                const hits = ray.intersectObjects([...colliders, ...state.builtBlocks]);

                player.velocity.x -= player.velocity.x * 10.0 * delta;
                player.velocity.z -= player.velocity.z * 10.0 * delta;
                player.velocity.y -= state.gravity * delta;
                
                const dir = new THREE.Vector3(Number(move.r)-Number(move.l), 0, Number(move.f)-Number(move.b)).normalize();
                if (move.f || move.b || move.l || move.r) {
                    const camDir = new THREE.Vector3();
                    camera.getWorldDirection(camDir);
                    camDir.y = 0; camDir.normalize();
                    const camRight = new THREE.Vector3(-camDir.z, 0, camDir.x);
                    
                    const moveVec = new THREE.Vector3().addScaledVector(camDir, dir.z).addScaledVector(camRight, dir.x);
                    
                    player.velocity.z += moveVec.z * state.speed * 10.0 * delta;
                    player.velocity.x += moveVec.x * state.speed * 10.0 * delta;
                }
                
                camera.position.x += player.velocity.x * delta;
                camera.position.z += player.velocity.z * delta;
                camera.position.y += player.velocity.y * delta;

                if(hits.length > 0) {
                    // Check if falling onto ground
                    if(player.velocity.y <= 0) {
                        player.velocity.y = 0; 
                        player.onGround = true;
                        // Snap to ground
                        camera.position.y = hits[0].point.y + 1.6;
                    }
                } else {
                    player.onGround = false;
                }

                if(camera.position.y < -30) playerDie();
                updateHUD();
            }

            // AUTOMATION
            autoTimer += delta;
            if(autoTimer > 2) {
                autoTimer = 0;
                state.collectors.forEach(c => {
                    if(c.type === 'farm' || c.type === 'magma') {
                        state.plots.forEach(p => {
                            if(p.mesh.position.distanceTo(c.mesh.position) < 20 && (p.zone==='magma')===(c.type==='magma')) {
                                if(p.status === 'ready') {
                                    p.status = 'empty'; p.plant.visible = false;
                                    const vals = { carrot:30, star:100, moon:300, lava:600, solar:500, void:800 };
                                    const exist = c.inventory.find(i=>i.name===p.type);
                                    if(exist) exist.count++; else c.inventory.push({name:p.type, val:vals[p.type], count:1});
                                }
                                if(p.status === 'empty') {
                                    // Complex seed selection for bot
                                    let seedName = null;
                                    if(c.type==='magma' && c.seeds.lava > 0) seedName = 'lava';
                                    else if(c.type==='farm') {
                                        if(c.seeds.void > 0) seedName='void';
                                        else if(c.seeds.solar > 0) seedName='solar';
                                        else if(c.seeds.moon > 0) seedName='moon';
                                        else if(c.seeds.star > 0) seedName='star';
                                        else if(c.seeds.carrot > 0) seedName='carrot';
                                    }
                                    
                                    if(seedName) {
                                        c.seeds[seedName]--;
                                        const cols = { carrot:0xffa502, star:0xffff00, moon:0x74b9ff, lava:0xff7675, solar:0xf1c40f, void:0x2c3e50 };
                                        plant(p, seedName, cols[seedName], 10);
                                    }
                                }
                            }
                        });
                    }
                    if(c.type === 'ranch') {
                        for(let i=animalDrops.length-1; i>=0; i--) {
                            if(animalDrops[i].mesh.position.distanceTo(c.mesh.position) < 15) {
                                const d = animalDrops[i];
                                const exist = c.inventory.find(x=>x.name===d.name);
                                if(exist) exist.count++; else c.inventory.push({name:d.name, val:d.val, count:1});
                                scene.remove(d.mesh); animalDrops.splice(i,1);
                            }
                        }
                    }
                });
            }

            // MOBS & BOSSES
            const pPos = camera.position;
            state.mobs.forEach(m => {
                if(m.active) {
                    const dist = m.mesh.position.distanceTo(pPos);
                    if(dist < 15 && dist > 1.5) {
                        m.mesh.lookAt(pPos.x, m.mesh.position.y, pPos.z);
                        m.mesh.position.add(m.mesh.getWorldDirection(new THREE.Vector3()).multiplyScalar(m.speed*delta));
                    }
                    if(dist < 2) {
                        m.atkCooldown -= delta;
                        if(m.atkCooldown <= 0) {
                            state.hp -= m.dmg; m.atkCooldown = 2; AudioSys.hit();
                            if(state.hp <= 0) playerDie();
                        }
                    }
                    m.mesh.position.y = 1 + Math.sin(clock.elapsedTime*2)*0.2;
                } else {
                    m.mesh.position.y = -100; m.respawn -= delta;
                    if(m.respawn <= 0) { m.active = true; m.hp = m.maxHp; m.mesh.visible = true; m.mesh.position.set(0 + (Math.random()-0.5)*30, 1, -80 + (Math.random()-0.5)*30); }
                }
            });

            state.trees.forEach(t => { if(!t.active) { t.respawn -= delta; if(t.respawn <= 0) { t.active=true; t.hp=3; t.mesh.visible=true; t.mesh.rotation.z=0; } } });

            // Boss 1 AI
            if(state.boss.active) {
                const b = state.boss.mesh; const dist = b.position.distanceTo(pPos);
                b.children.forEach((c,i) => { if(i>1) c.rotation.y += delta*2; });
                if(dist > 5) { b.lookAt(pPos.x, 5, pPos.z); b.position.add(b.getWorldDirection(new THREE.Vector3()).multiplyScalar(4*delta)); }
                if(dist < 8) { state.boss.cooldown -= delta; if(state.boss.cooldown <= 0) { state.boss.cooldown = 1.5; state.hp -= 20; AudioSys.hit(); if(state.hp <= 0) playerDie(); } }
            }
            // Boss 2 AI (Void)
            if(state.boss2.active) {
                const b = state.boss2.mesh; const dist = b.position.distanceTo(pPos);
                if(dist > 5) { b.lookAt(pPos.x, 5, pPos.z); b.position.add(b.getWorldDirection(new THREE.Vector3()).multiplyScalar(3.5*delta)); } // Slower but tougher
                if(dist < 10) { 
                    state.boss2.cooldown -= delta; 
                    if(state.boss2.cooldown <= 0) { 
                        state.boss2.cooldown = 1.2; state.hp -= 35; AudioSys.hit(); 
                        showToast("Void Strike!"); 
                        if(state.hp <= 0) playerDie(); 
                    } 
                }
            }

            state.ores.forEach(o => { if(!o.active) { o.respawn -= delta; if(o.respawn <= 0) { o.active=true; o.hp=o.maxHp; o.mesh.visible=true; if(o.name==='Sky Crystal') o.mesh.scale.setScalar(1); else o.mesh.position.y=0.5; } } });
            state.plots.forEach(p => { if(p.status === 'growing') { let spd = p.hasSprinkler ? 2 : 1; p.timer -= delta * spd; if(p.timer <= 0) { p.status = 'ready'; p.plant.material.color.setHex(0xFFD700); p.plant.scale.set(1,1,1); } else { const s = 0.1 + (1-(p.timer/p.maxTime))*0.9; p.plant.scale.setScalar(s); } if(p.hasSprinkler) p.spr.rotation.y += delta*5; } });
            state.animals.forEach(a => {
                if(a.mesh.position.distanceTo(a.target) < 0.5) { a.target.x = -70 + (Math.random()-0.5)*10; a.target.z = 0 + (Math.random()-0.5)*10; }
                a.mesh.lookAt(a.target); a.mesh.position.add(a.mesh.getWorldDirection(new THREE.Vector3()).multiplyScalar(2*delta)); a.mesh.position.y = 1 + Math.abs(Math.sin(clock.elapsedTime*5))*0.5;
                
                // Upgrade: Ranch Speed
                let prodSpeed = state.upgrades.ranchSpeed ? 2 : 1;
                a.produceTimer -= delta * prodSpeed;
                
                if(a.produceTimer <= 0) {
                    a.produceTimer = 15; const drop = new THREE.Mesh(new THREE.DodecahedronGeometry(0.3), new THREE.MeshStandardMaterial({color:0xffff00}));
                    drop.position.copy(a.mesh.position); scene.add(drop); animalDrops.push({mesh:drop, val: a.type==='chicken'?50:150, name: a.type==='chicken'?'Egg':'Slime Goo'}); AudioSys.pop();
                }
            });
            for(let i=animalDrops.length-1; i>=0; i--) {
                const d = animalDrops[i]; d.mesh.rotation.y += delta;
                if(pPos.distanceTo(d.mesh.position) < 2) { if(addToInventory(d.name, d.val, 'animal')) { scene.remove(d.mesh); animalDrops.splice(i,1); AudioSys.coin(); showToast(`Collected!`); } }
            }
            
            if(state.fishing.state === 'WAITING') {
                state.fishing.timer -= delta;
                state.fishing.bobber.position.y = -3.5 + Math.sin(clock.elapsedTime*3)*0.1;
                if(state.fishing.timer <= 0) {
                    state.fishing.state = 'HOOKED';
                    document.getElementById('reaction-cue').style.display = 'block'; 
                    state.fishing.bobber.position.y = -4; AudioSys.splash();
                }
            }

            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>wa	aw	waawa  w 